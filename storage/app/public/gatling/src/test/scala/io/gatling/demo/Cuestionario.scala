package io.gatling.demo

import io.gatling.core.Predef._
import io.gatling.http.Predef._
import scala.util.Random
import scala.collection.mutable.ArrayBuffer

import scala.concurrent.duration._
import java.io.File

import com.typesafe.config.{Config, ConfigFactory}

class Cuestionario extends Simulation {

	val config = ConfigFactory.parseFile(new File("src/test/resources/data.conf"))

	val anws = ArrayBuffer[String]()

	def patern_anws() ={
		val src = scala.io.Source.fromFile("src/test/resources/anwser_patern.csv").getLines
		val headerLine = src.take(1).next

		for(l <- src) {
			// split line by comma and process them
			l.split(",").map { c =>
				anws+= c.toString
			}
		}
	}


	def rand_anws(): String = {
		var answers = Array("1", "2", "3", "4")
		var random_answer = "A" + answers(Random.nextInt(answers.length))
		return random_answer.toString
	}
	def rand_feed_anws()={
		for( w <- 0 to 100){
			anws+= rand_anws()
		}
	}

	if(config.getString("anw_rand").toInt== 0){
		patern_anws()
	}else{
		rand_feed_anws()
	}


	println(anws(1))
	println(anws(2))
	println(anws(3))


	var question_counter_offset = 2
	val nbUsers = Integer.getInteger("users", 1)
	val nbDuration = Integer.getInteger("Dmaxduration", 60)

	val httpProtocol = http
		.baseUrl(config.getString("url_base"))
		.userAgentHeader("Apache-HttpClient/4.5.5 (Java/1.8.0_191)")
		.header("Connection", "keep-alive")
		.disableCaching // no caching
	
	val scn = scenario("Cuestionario")
		.feed(csv("tokens_732668.csv").queue)
		.exec(flushCookieJar) // flush all cookies

		.exec(http("recover_token")
			.get(config.getString("url_post"))
			.check(css("input[name=\"YII_CSRF_TOKEN\"]","value").saveAs("YII"))
			.check(status.is(200))
		).pause(5.seconds,20.seconds)

		.exec(http("login")
			.post(config.getString("url_post"))
			.formParam("YII_CSRF_TOKEN", "${YII}")
			.formParam("token", "${token}")
			.formParam("continue", "continue")
		).pause(5.seconds,20.seconds)

		.exec(http("recover_data_lime")
			.get(config.getString("url_post"))
			.check(css("#LEMpostKey","value").saveAs("LEMpostKey"))
			.check(css("#sid","value").saveAs("SID"))
		).pause(5.seconds,20.seconds)

		.exec(http("terms")
			.post(config.getString("url_post"))
			.formParam("YII_CSRF_TOKEN", "${YII}")
			.formParam("fieldnames", "")
			.formParam("sid", "${SID}")
			.formParam("lastgroupname", "_WELCOME_SCREEN_")
			.formParam("LEMpostKey", "${LEMpostKey}")
			.formParam("thisstep", "0")
			.formParam("token", "${token}")
			.formParam("move", "movenext")
			.formParam("ajax", "off")
			.check(css("#start_time","value").saveAs("start_time"))
			.check(css("#LEMpostKey","value").saveAs("LEMpostKey"))
			.check(css("#fieldnames","value").saveAs("fieldnames"))
			.check(css("input[name=\"YII_CSRF_TOKEN\"]","value").saveAs("YII"))
		).pause(5.seconds,20.seconds)
		
		.exec(http("request_3")
			.post(config.getString("url_post"))
			.formParam("YII_CSRF_TOKEN", "${YII}")
			.formParam("fieldnames", "732668X149X292")
			.formParam("thisstep", "1")
			.formParam("sid", "732668")
			.formParam("start_time", "1604765608")
			.formParam("LEMpostKey", "${LEMpostKey}")
			.formParam("token", "${token}")
			.formParam("relevance292", "1")
			.formParam("relevanceG0", "1")
			.formParam("732668X149X292", anws(1))
			.formParam("lastgroup", "732668X149")
			.formParam("move", "movenext")
			.formParam("ajax", "off")
			.check(css("#LEMpostKey","value").saveAs("LEMpostKey"))
		).pause(5.seconds,20.seconds)
		
		.exec(http("request_4")
			.post(config.getString("url_post"))
			.formParam("YII_CSRF_TOKEN", "${YII}")
			.formParam("fieldnames", "732668X150X293")
			.formParam("thisstep", "2")
			.formParam("sid", "732668")
			.formParam("start_time", "1604765612")
			.formParam("LEMpostKey", "${LEMpostKey}")
			.formParam("token", "${token}")
			.formParam("relevance293", "1")
			.formParam("relevanceG1", "1")
			.formParam("732668X150X293", "A2")
			.formParam("lastgroup", "732668X150")
			.formParam("move", "movenext")
			.formParam("ajax", "off")
			.check(css("#LEMpostKey","value").saveAs("LEMpostKey"))
		).pause(5.seconds,20.seconds)
		
		.exec(http("request_5")
			.post(config.getString("url_post"))
			.formParam("YII_CSRF_TOKEN", "${YII}")
			.formParam("fieldnames", "732668X151X294SQ001|732668X151X294SQ002|732668X151X294SQ003|732668X151X294SQ004|732668X151X294SQ005|732668X151X294SQ006|732668X151X294SQ007|732668X151X294SQ008|732668X151X294SQ009|732668X151X294SQ010")
			.formParam("thisstep", "3")
			.formParam("sid", "732668")
			.formParam("start_time", "1604765622")
			.formParam("LEMpostKey", "${LEMpostKey}")
			.formParam("token", "${token}")
			.formParam("relevance294", "1")
			.formParam("relevanceG2", "1")
			.formParam("732668X151X294SQ001", anws(2))
			.formParam("732668X151X294SQ002", anws(3))
			.formParam("732668X151X294SQ003", anws(4))
			.formParam("732668X151X294SQ004", anws(5))
			.formParam("732668X151X294SQ005", anws(6))
			.formParam("732668X151X294SQ006", anws(7))
			.formParam("732668X151X294SQ007", anws(8))
			.formParam("732668X151X294SQ008", anws(9))
			.formParam("732668X151X294SQ009", anws(10))
			.formParam("732668X151X294SQ010", anws(12))
			.formParam("lastgroup", "732668X151")
			.formParam("move", "movenext")
			.formParam("ajax", "off")
			.check(css("#LEMpostKey","value").saveAs("LEMpostKey"))
		).pause(5.seconds,20.seconds)
		
		.exec(http("request_6")
			.post(config.getString("url_post"))
			.formParam("YII_CSRF_TOKEN", "${YII}")
			.formParam("fieldnames", "732668X152X306SQ001|732668X152X306SQ002|732668X152X306SQ003|732668X152X306SQ004")
			.formParam("thisstep", "4")
			.formParam("sid", "732668")
			.formParam("start_time", "1604765637")
			.formParam("LEMpostKey", "${LEMpostKey}")
			.formParam("token", "${token}")
			.formParam("relevance306", "1")
			.formParam("relevanceG3", "1")
			.formParam("732668X152X306SQ001", anws(12))
			.formParam("732668X152X306SQ002", anws(13))
			.formParam("732668X152X306SQ003", anws(14))
			.formParam("732668X152X306SQ004", anws(15))
			.formParam("lastgroup", "732668X152")
			.formParam("move", "movenext")
			.formParam("ajax", "off")
			.check(css("#LEMpostKey","value").saveAs("LEMpostKey"))
		).pause(5.seconds,20.seconds)
		
		.exec(http("request_7")
			.post(config.getString("url_post"))
			.formParam("YII_CSRF_TOKEN", "${YII}")
			.formParam("fieldnames", "732668X153X315SQ001|732668X153X315SQ002|732668X153X315SQ003")
			.formParam("thisstep", "5")
			.formParam("sid", "732668")
			.formParam("start_time", "1604765642")
			.formParam("LEMpostKey", "${LEMpostKey}")
			.formParam("token", "${token}")
			.formParam("relevance315", "1")
			.formParam("relevanceG4", "1")
			.formParam("732668X153X315SQ001", anws(16))
			.formParam("732668X153X315SQ002", anws(17))
			.formParam("732668X153X315SQ003", anws(18))
			.formParam("lastgroup", "732668X153")
			.formParam("move", "movenext")
			.formParam("ajax", "off")
			.check(css("#LEMpostKey","value").saveAs("LEMpostKey"))
		).pause(5.seconds,20.seconds)
		
		.exec(http("request_8")
			.post(config.getString("url_post"))
			.formParam("YII_CSRF_TOKEN", "${YII}")
			.formParam("fieldnames", "732668X446X730")
			.formParam("thisstep", "6")
			.formParam("sid", "732668")
			.formParam("start_time", "1604765648")
			.formParam("LEMpostKey", "${LEMpostKey}")
			.formParam("token", "${token}")
			.formParam("relevance730", "1")
			.formParam("relevanceG5", "1")
			.formParam("732668X446X730", anws(19))
			.formParam("lastgroup", "732668X446")
			.formParam("move", "movenext")
			.formParam("ajax", "off")
			.check(css("#LEMpostKey","value").saveAs("LEMpostKey"))
		).pause(5.seconds,20.seconds)
		
		.exec(http("request_9")
			.post(config.getString("url_post"))
			.formParam("YII_CSRF_TOKEN", "${YII}")
			.formParam("fieldnames", "732668X154X321")
			.formParam("thisstep", "7")
			.formParam("sid", "732668")
			.formParam("start_time", "1604765651")
			.formParam("LEMpostKey", "${LEMpostKey}")
			.formParam("token", "${token}")
			.formParam("relevance321", "1")
			.formParam("relevanceG6", "1")
			.formParam("732668X154X321", anws(20))
			.formParam("lastgroup", "732668X154")
			.formParam("move", "movenext")
			.formParam("ajax", "off")
			.check(css("#LEMpostKey","value").saveAs("LEMpostKey"))
		).pause(5.seconds,20.seconds)
		
		.exec(http("request_10")
			.post(config.getString("url_post"))
			.formParam("YII_CSRF_TOKEN", "${YII}")
			.formParam("fieldnames", "732668X155X320")
			.formParam("thisstep", "8")
			.formParam("sid", "732668")
			.formParam("start_time", "1604765655")
			.formParam("LEMpostKey", "${LEMpostKey}")
			.formParam("token", "${token}")
			.formParam("relevance320", "1")
			.formParam("relevanceG7", "1")
			.formParam("732668X155X320", anws(21))
			.formParam("lastgroup", "732668X155")
			.formParam("move", "movenext")
			.formParam("ajax", "off")
			.check(css("#LEMpostKey","value").saveAs("LEMpostKey"))
		).pause(5.seconds,20.seconds)
		
		.exec(http("request_11")
			.post(config.getString("url_post"))
			.formParam("YII_CSRF_TOKEN", "${YII}")
			.formParam("fieldnames", "732668X156X322")
			.formParam("thisstep", "9")
			.formParam("sid", "732668")
			.formParam("start_time", "1604765658")
			.formParam("LEMpostKey", "${LEMpostKey}")
			.formParam("token", "${token}")
			.formParam("relevance322", "1")
			.formParam("relevanceG8", "1")
			.formParam("732668X156X322", anws(22))
			.formParam("lastgroup", "732668X156")
			.formParam("move", "movenext")
			.formParam("ajax", "off")
			.check(css("#LEMpostKey","value").saveAs("LEMpostKey"))
		).pause(5.seconds,20.seconds)
		
		.exec(http("request_12")
			.post(config.getString("url_post"))
			.formParam("YII_CSRF_TOKEN", "${YII}")
			.formParam("fieldnames", "732668X157X323SQ001|732668X157X323SQ002|732668X157X323SQ003|732668X157X323SQ004|732668X157X323SQ005|732668X157X323SQ006|732668X157X323SQ007|732668X157X323SQ008|732668X157X323SQ009|732668X157X323SQ010|732668X157X323SQ011|732668X157X323SQ012")
			.formParam("thisstep", "10")
			.formParam("sid", "732668")
			.formParam("start_time", "1604765661")
			.formParam("LEMpostKey", "${LEMpostKey}")
			.formParam("token", "${token}")
			.formParam("relevance323", "1")
			.formParam("relevanceG9", "1")
			.formParam("732668X157X323SQ001", anws(23))
			.formParam("732668X157X323SQ002", anws(24))
			.formParam("732668X157X323SQ003", anws(25))
			.formParam("732668X157X323SQ004", anws(26))
			.formParam("732668X157X323SQ005", anws(27))
			.formParam("732668X157X323SQ006", anws(28))
			.formParam("732668X157X323SQ007", anws(29))
			.formParam("732668X157X323SQ008", anws(30))
			.formParam("732668X157X323SQ009", anws(31))
			.formParam("732668X157X323SQ010", anws(32))
			.formParam("732668X157X323SQ011", anws(33))
			.formParam("732668X157X323SQ012", anws(34))
			.formParam("lastgroup", "732668X157")
			.formParam("move", "movenext")
			.formParam("ajax", "off")
			.check(css("#LEMpostKey","value").saveAs("LEMpostKey"))
		).pause(5.seconds,20.seconds)
		
		.exec(http("request_13")
			.post(config.getString("url_post"))
			.formParam("YII_CSRF_TOKEN", "${YII}")
			.formParam("fieldnames", "732668X447X731SQ001|732668X447X731SQ002|732668X447X731SQ003")
			.formParam("thisstep", "11")
			.formParam("sid", "732668")
			.formParam("start_time", "1604765671")
			.formParam("LEMpostKey", "${LEMpostKey}")
			.formParam("token", "${token}")
			.formParam("relevance731", "1")
			.formParam("relevanceG10", "1")
			.formParam("732668X447X731SQ001", anws(35))
			.formParam("732668X447X731SQ002", anws(36))
			.formParam("732668X447X731SQ003", anws(37))
			.formParam("lastgroup", "732668X447")
			.formParam("move", "movenext")
			.formParam("ajax", "off")
			.check(css("#LEMpostKey","value").saveAs("LEMpostKey"))
		).pause(5.seconds,20.seconds)
		
		.exec(http("request_14")
			.post(config.getString("url_post"))
			.formParam("YII_CSRF_TOKEN", "${YII}")
			.formParam("fieldnames", "732668X158X337SQ001|732668X158X337SQ002|732668X158X337SQ003")
			.formParam("thisstep", "12")
			.formParam("sid", "732668")
			.formParam("start_time", "1604765676")
			.formParam("LEMpostKey", "${LEMpostKey}")
			.formParam("token", "${token}")
			.formParam("relevance337", "1")
			.formParam("relevanceG11", "1")
			.formParam("732668X158X337SQ001", anws(38))
			.formParam("732668X158X337SQ002", anws(39))
			.formParam("732668X158X337SQ003", anws(40))
			.formParam("lastgroup", "732668X158")
			.formParam("move", "movenext")
			.formParam("ajax", "off")
			.check(css("#LEMpostKey","value").saveAs("LEMpostKey"))
		).pause(5.seconds,20.seconds)
		
		.exec(http("request_15")
			.post(config.getString("url_post"))
			.formParam("YII_CSRF_TOKEN", "${YII}")
			.formParam("fieldnames", "732668X159X342SQ001|732668X159X342SQ002|732668X159X342SQ003|732668X159X342SQ004|732668X159X342SQ005|732668X159X342SQ006|732668X159X342SQ007|732668X159X342SQ008")
			.formParam("thisstep", "13")
			.formParam("sid", "732668")
			.formParam("start_time", "1604765680")
			.formParam("LEMpostKey", "${LEMpostKey}")
			.formParam("token", "${token}")
			.formParam("relevance342", "1")
			.formParam("relevanceG12", "1")
			.formParam("732668X159X342SQ001", anws(41))
			.formParam("732668X159X342SQ002", anws(42))
			.formParam("732668X159X342SQ003", anws(43))
			.formParam("732668X159X342SQ004", anws(44))
			.formParam("732668X159X342SQ005", anws(44))
			.formParam("732668X159X342SQ006", anws(45))
			.formParam("732668X159X342SQ007", anws(46))
			.formParam("732668X159X342SQ008", anws(47))
			.formParam("lastgroup", "732668X159")
			.formParam("move", "movenext")
			.formParam("ajax", "off")
			.check(css("#LEMpostKey","value").saveAs("LEMpostKey"))
		).pause(5.seconds,20.seconds)
		
		.exec(http("request_16")
			.post(config.getString("url_post"))
			.formParam("YII_CSRF_TOKEN", "${YII}")
			.formParam("fieldnames", "732668X162X368SQ001|732668X162X368SQ002|732668X162X368SQ003")
			.formParam("thisstep", "14")
			.formParam("sid", "732668")
			.formParam("start_time", "1604765689")
			.formParam("LEMpostKey", "${LEMpostKey}")
			.formParam("token", "${token}")
			.formParam("relevance368", "1")
			.formParam("relevanceG13", "1")
			.formParam("732668X162X368SQ001", anws(48))
			.formParam("732668X162X368SQ002", anws(49))
			.formParam("732668X162X368SQ003", anws(50))
			.formParam("lastgroup", "732668X162")
			.formParam("move", "movenext")
			.formParam("ajax", "off")
			.check(css("#LEMpostKey","value").saveAs("LEMpostKey"))
		).pause(5.seconds,20.seconds)
		
		.exec(http("request_17")
			.post(config.getString("url_post"))
			.formParam("YII_CSRF_TOKEN", "${YII}")
			.formParam("fieldnames", "732668X272X546SQ001|732668X272X546SQ002|732668X272X546SQ003|732668X272X546SQ004|732668X272X546SQ005|732668X272X546SQ006|732668X272X546SQ007|732668X272X546SQ008")
			.formParam("thisstep", "15")
			.formParam("sid", "732668")
			.formParam("start_time", "1604765693")
			.formParam("LEMpostKey", "${LEMpostKey}")
			.formParam("token", "${token}")
			.formParam("relevance546", "1")
			.formParam("relevanceG14", "1")
			.formParam("732668X272X546SQ001", anws(51))
			.formParam("732668X272X546SQ002", anws(52))
			.formParam("732668X272X546SQ003", anws(53))
			.formParam("732668X272X546SQ004", anws(54))
			.formParam("732668X272X546SQ005", anws(55))
			.formParam("732668X272X546SQ006", anws(56))
			.formParam("732668X272X546SQ007", anws(57))
			.formParam("732668X272X546SQ008", anws(58))
			.formParam("lastgroup", "732668X272")
			.formParam("move", "movenext")
			.formParam("ajax", "off")
			.check(css("#LEMpostKey","value").saveAs("LEMpostKey"))
		).pause(5.seconds,20.seconds)
		
		.exec(http("request_18")
			.post(config.getString("url_post"))
			.formParam("YII_CSRF_TOKEN", "${YII}")
			.formParam("fieldnames", "732668X161X362SQ001|732668X161X362SQ002|732668X161X362SQ003|732668X161X362SQ004")
			.formParam("thisstep", "16")
			.formParam("sid", "732668")
			.formParam("start_time", "1604765704")
			.formParam("LEMpostKey", "${LEMpostKey}")
			.formParam("token", "${token}")
			.formParam("relevance362", "1")
			.formParam("relevanceG15", "1")
			.formParam("732668X161X362SQ001", anws(59))
			.formParam("732668X161X362SQ002", anws(60))
			.formParam("732668X161X362SQ003", anws(61))
			.formParam("732668X161X362SQ004", anws(62))
			.formParam("lastgroup", "732668X161")
			.formParam("move", "movenext")
			.formParam("ajax", "off")
			.check(css("#LEMpostKey","value").saveAs("LEMpostKey"))
		).pause(5.seconds,20.seconds)
		
		.exec(http("request_19")
			.post(config.getString("url_post"))
			.formParam("YII_CSRF_TOKEN", "${YII}")
			.formParam("fieldnames", "732668X187X459")
			.formParam("thisstep", "17")
			.formParam("sid", "732668")
			.formParam("start_time", "1604765710")
			.formParam("LEMpostKey", "${LEMpostKey}")
			.formParam("token", "${token}")
			.formParam("relevance459", "1")
			.formParam("relevanceG16", "1")
			.formParam("732668X187X459", "")
			.formParam("lastgroup", "732668X187")
			.formParam("move", "movesubmit")
			.formParam("ajax", "off"))

	setUp(scn.inject(atOnceUsers(config.getString("n_user").toInt))).protocols(httpProtocol)
}